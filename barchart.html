<!DOCTYPE html>
<html>
    <head>
        <script type="text/javascript" src="underscore-min.js"></script>
        <script type="text/javascript" src="d3.min.js"></script>
        <script type="text/javascript" src="d3.geom.min.js"></script>
    </head>
    <body>
        <div id="org_barchart"></div>
        <div id="industries_barchart"></div>
        <div id="piechart_local"></div>
        <div id="piechart_party"></div>
        <script type="text/javascript">
            var D3Charts = {
                barchart: function(div, data, opts) {
                    var default_opts = {
                        chart_height: 195,
                        chart_width: 235,
                        chart_x: 215,
                        chart_y: 10,
                        bar_gutter: 5,
                        right_gutter: 70,
                        row_height: 18,
                        bar_height: 14,
                        chart_padding: 4,
                        colors : ["#efcc01", "#f27e01"],
                        axis_color: "#827d7d",
                        text_color: "#666666",
                        link_color: "#0a6e92"
                    };
                    if (typeof opts === 'undefined') opts = {};
                    _.defaults(opts, default_opts);


                    totals = _.map(data, function(item) { return d3.sum(item.values); })

                    var chart = d3.select('#' + div).append("svg")
                        .attr("class", "chart")
                        .attr("width", opts.chart_x + opts.chart_width + opts.right_gutter)
                        .attr("height", opts.chart_height);

                    var width = d3.scale.linear()
                        .domain([0, d3.max(totals)])
                        .range([0, opts.chart_width]);
                    
                    var yPos = d3.scale.ordinal()
                        .domain(totals)
                        .rangeBands([opts.chart_y + opts.chart_padding, opts.chart_y + (opts.row_height * data.length) + opts.chart_padding]);

                    
                    // bars
                    chart.selectAll("g")
                        .data(data)
                    .enter().append("g")
                        .attr("transform", function(d, i) {
                            return "translate(" + opts.chart_x + "," + yPos(i) + ")";
                        })
                    .selectAll("path")
                        .data(function(d) { return _.map(_.range(d.values.length), function(j) { return d3.sum(d.values.slice(0, j + 1))}).reverse(); })
                    .enter().append("path")
                        .attr("d", function(d, i) {
                            var x = 0;
                            var y = 0;
                            var h = opts.bar_height;

                            var r = 4;

                            var w = width(d, i);

                            var array = [].concat(
                                ["M", x, y],
                                ["L", d3.max([x + w - r, 0]), y, "Q", x + w, y, x + w, y + r],
                                ["L", x + w, d3.max([y + h - r, 0]), "Q", x + w, y + h, d3.max([x + w - r, 0]), y + h],
                                ["L", x, y + h, "Z"]
                            );

                            return array.join(" ");
                        })
                        .attr("fill", function(d, i) { return opts.colors[data[0].values.length - i - 1] });
                    
                    // numbers
                    var format = d3.format(',.0f');
                    chart.selectAll("text.chart-number")
                        .data(totals)
                    .enter().append("text")
                        .classed('chart-number', true)
                        .attr("x", function(d, i) { return opts.chart_x + width(d, i) + opts.bar_gutter; })
                        .attr("y", function(d, i) { return yPos(i) + yPos.rangeBand() / 2; })
                        .attr("dy", ".15em") // vertical-align: middle
                        .attr('fill', opts.text_color)
                        .text(function(d, i) { return '$' + format(d); })
                        .style('font', '11px arial,sans-serif');
                    
                    // labels
                    chart.selectAll("g.chart-label")
                        .data(data)
                    .enter().append("g")
                        .classed('chart-label', true)
                        .attr("transform", function(d, i) { return "translate(0," + (yPos(i) + yPos.rangeBand() / 2) + ")"; })
                        .each(function(d, i) {
                            var parent = d3.select(this);
                            if (d.href) {
                                parent = parent.append("a")
                                parent.attr('xlink:href', d.href);
                            }
                            parent.append("text")
                                .attr("dy", ".15em") // vertical-align: middle
                                .attr('fill', parent.node().tagName == 'a' ? opts.link_color : opts.text_color)
                                .text(function(d, i) { return d.key; })
                                .style('font', '11px arial,sans-serif');
                        })
                    
                    // axes
                    chart.append("line")
                        .attr("x1", opts.chart_x - .5)
                        .attr("x2", opts.chart_x - .5)
                        .attr("y1", opts.chart_y)
                        .attr("y2", opts.chart_y + (data.length * opts.row_height) + opts.chart_padding)
                        .style("stroke", opts.axis_color)
                        .style("stroke-width", "1");
                    
                    chart.append("line")
                        .attr("x1", opts.chart_x)
                        .attr("x2", opts.chart_x + opts.chart_width + opts.right_gutter)
                        .attr("y1", opts.chart_y + (data.length * opts.row_height) + opts.chart_padding - .5)
                        .attr("y2", opts.chart_y + (data.length * opts.row_height) + opts.chart_padding - .5)
                        .style("stroke", opts.axis_color)
                        .style("stroke-width", "1");
                },
                piechart: function(div, data, opts) {
                    var default_opts = {
                        chart_height: 116,
                        chart_width: 240,
                        chart_r: 54,
                        chart_cx: 58,
                        chart_cy: 58,
                        colors : ["#efcc01", "#f2e388"],
                        text_color: "#666666",
                        amount_color: '#000000',
                        row_height: 14,
                        legend_padding: 15,
                        legend_r: 5
                    };
                    if (typeof opts === 'undefined') opts = {};
                    _.defaults(opts, default_opts);

                    var twopi = 2 * Math.PI;
                    
                    var chart = d3.select("#" + div)
                        .append("svg")
                            .attr("width", opts.chart_width)
                            .attr("height", opts.chart_height);
                    
                    // pie
                    _.each(data, function(d, i) { d.color = opts.colors[i]; });
                    data = _.sortBy(data, function(d) { return d.value; }).reverse();
                    var values = _.map(data, function(d) { return d.value; })

                    var aScale = d3.scale.linear()
                        .domain([0, d3.sum(values)])
                        .range([0, twopi]);
                    
                    var marker = -1 * aScale(values[0]) / 2;
                    var sectors = []
                    for (var i = 0; i < values.length; i++) {
                        var sector = {
                            'startAngle': marker,
                            'innerRadius': 0,
                            'outerRadius': opts.chart_r
                        }
                        marker += aScale(values[i]);
                        sector['endAngle'] = marker;
                        sectors.push(sector);
                    }

                    var circle = chart.append("g")
                            .attr("transform", "translate(" + opts.chart_cx + "," + opts.chart_cy + ")")

                    var arc = d3.svg.arc();
                                        
                    var arcs = circle.selectAll("g.slice")
                        .data(sectors)
                        .enter()
                            .append("g")
                            .classed("slice", true)
                            .attr("data-slice", function(d, i) { return i; });
                        
                        arcs.append("path")
                            .attr("fill", function(d, i) { return data[i].color; } )
                            .attr("d", arc)
                            .on("mouseover", function(d, i) {
                                chart.selectAll('g[data-slice="' + i + '"] path')
                                    .attr('transform', 'scale(1.05)');
                                chart.selectAll('g[data-slice="' + i + '"] circle')
                                    .attr('transform', 'scale(1.5)');
                                chart.selectAll('text[data-slice="' + i + '"]')
                                    .style('display', null);
                                chart.selectAll('g[data-slice="' + i + '"] text')
                                    .style('font-weight', 'bold');
                            })
                            .on("mouseout", function(d, i) {
                                chart.selectAll('g[data-slice="' + i + '"] path, g[data-slice="' + i + '"] circle')
                                    .transition()
                                        .duration(200)
                                        .attr('transform', 'scale(1)');
                                chart.selectAll('text[data-slice="' + i + '"]')
                                    .style('display', 'none');
                                chart.selectAll('g[data-slice="' + i + '"] text')
                                    .style('font-weight', null);
                            });


                        /* arcs.append("text")
                            .attr("transform", function(d) {
                                //we have to make sure to set these before calling arc.centroid
                                d.innerRadius = 0;
                                d.outerRadius = opts.chart_r;
                                return "translate(" + arc.centroid(d) + ")";
                            })
                            .attr("text-anchor", "middle")
                            .text(function(d, i) { return data[i].key; })
                            .attr('fill', opts.text_color)
                            .style('font', '11px arial,sans-serif'); */
                    
                    // legend
                    var legend_x = opts.chart_cx + opts.chart_r + opts.legend_padding;
                    var legend_y = opts.chart_cy - (data.length * opts.row_height / 2);
                    var legend = chart.append("g")
                        .attr("transform", "translate(" + legend_x + "," + legend_y + ")");
                    
                    var sum = d3.sum(values);
                    var legendItems = legend.selectAll("g.legend-item")
                        .data(data)
                        .enter()
                            .append("g")
                            .classed("legend-item", true)
                            .attr("data-slice", function(d, i) { return i; })
                            .attr("transform", function(d, i) { return "translate(0," + ((i + .5) * opts.row_height) + ")"; })
                    
                        legendItems.append("circle")
                            .attr("fill", function(d, i) { return d.color; })
                            .attr("cx", 0)
                            .attr("cy", 0)
                            .attr("r", opts.legend_r);
                        
                        legendItems.append("text")
                            .attr("dy", ".45em") // vertical-align: middle
                            .attr("dx", opts.legend_padding)
                            .attr('fill', opts.text_color)
                            .text(function(d, i) { return d.key + " (" + Math.round(100 * d.value / sum) + "%)"; })
                            .style('font', '11px arial,sans-serif');
                    
                    // amounts
                    var format = d3.format(',.0f');
                    var amounts = chart.selectAll("text.amount")
                        .data(data)
                        .enter()
                            .append("text")
                            .classed("amount", true)
                            .attr("x", opts.chart_cx)
                            .attr("y", opts.chart_cy)
                            .attr("dy", ".5em") // vertical-align: middle
                            .attr('fill', opts.amount_color)
                            .attr('data-slice', function(d, i) { return i; })
                            .text(function(d, i) { return '$' + format(d.value); })
                            .style('font', 'bold 12px arial,sans-serif')
                            .style('text-anchor', 'middle')
                            .style('display', 'none');
                }
            }

            var Brisket = {
                contribution_single_barchart: function(div, data) {
                    if (data.length === 0) return;
                    
                    graph_data = _.map(data, function(item) {
                        return {
                            key: item.key,
                            href: item.href,
                            values: [parseFloat(item.value)]
                        };
                    });

                    D3Charts.barchart(div, graph_data);
                },
                contribution_stacked_barchart: function(div, data) {
                    if (data.length === 0) return;

                    graph_data = _.map(data, function(item) {
                        return {
                            key: item.key,
                            href: item.href,
                            values: [parseFloat(item.value_employee), parseFloat(item.value_pac)]
                        };
                    });
                    D3Charts.barchart(div, graph_data);
                },
                piechart: function(div, data, colors) {
                    var in_data = []
                    var opts = {colors: []}
                    _.each(data, function(value, key) {
                        in_data.push({'key': key, 'value': value})
                        opts.colors.push(colors[key]);
                    })
                    D3Charts.piechart(div, in_data, opts);
                },
                party_piechart: function(div, data) {
                    var party_colors = {"Republicans": "#E60002", "Democrats": "#186582", "Other" : "#DCDDDE"};
                    Brisket.piechart(div, data, party_colors);
                },
                indiv_pac_piechart: function(div, data) {
                    var indiv_pac_colors = {"Individuals": '#efcc01', "PACs": '#f2e388'};
                    Brisket.piechart(div, data, indiv_pac_colors);
                },
                local_piechart: function(div, data) {
                    var local_colors = {"in-state": '#efcc01', "out-of-state": '#f2e388', "unknown": '#dcddde'};
                    Brisket.piechart(div, data, local_colors);
                },
                level_piechart: function(div, data) {
                    var indiv_pac_colors = {"Federal": '#efcc01', "State": '#f2e388'};
                    Brisket.piechart(div, data, level_colors);
                }
            }

            Brisket.contribution_single_barchart("industries_barchart", [{"href": "/industry/retired/b21467ae32924f84ada9076535401a91", "value": "29619832.00", "key": "Retired"}, {"href": "/industry/lawyerslaw-firms/f50cf984a2e3477c8167d32e2b14e052", "value": "17713635.00", "key": "Lawyers/Law Firms"}, {"href": "/industry/real-estate/7500030dffe24844aa467a75f7aedfd1", "value": "14795731.00", "key": "Real Estate"}, {"href": "/industry/securities-investment/0af3f418f426497e8bbf916bfc074ebc", "value": "13346195.00", "key": "Securities & Investment"}, {"href": "/industry/health-professionals/a05a0d06f6814b31bece35a81fcb40c7", "value": "9452910.00", "key": "Health Professionals"}, {"href": "/industry/misc-business/d9c4a26cd671436eac3c501184364fc4", "value": "8590088.00", "key": "Misc Business"}, {"href": "/industry/misc-finance/05b23aff0dbd4b74b95b3e16074a874c", "value": "8158822.00", "key": "Misc Finance"}, {"href": "/industry/business-services/e5175721aac9406795a1f97cae01e01d", "value": "5812598.00", "key": "Business Services"}, {"href": "/industry/general-contractors/ad689c2a2bf744cc82237f851cd3f2c0", "value": "5174008.00", "key": "General Contractors"}, {"href": "/industry/insurance/8ada0fc2d6994f2ab06c7e025dff2284", "value": "4909761.00", "key": "Insurance"}] );
            Brisket.contribution_stacked_barchart("org_barchart", [{"href": "", "value_employee": "515938.00", "value": "515938.00", "key": "RNC/Repub National State Elections...", "value_pac": "0"}, {"href": "/organization/republican-national-cmte/00b3c4b8c7544003804726b54df663c3", "value_employee": "220539.00", "value": "260798.00", "key": "Republican National Cmte", "value_pac": "40259.00"}, {"href": "/organization/national-republican-congressional-cmte/e8d9336a139241c9ad792070ce85eec8", "value_employee": "39594.00", "value": "234594.00", "key": "National Republican Congressional ...", "value_pac": "195000.00"}, {"href": "/organization/democratic-congressional-campaign-cmte/52a8f5ae450f4507ab79f705c832a41f", "value_employee": "20454.00", "value": "221754.00", "key": "Democratic Congressional Campaign ...", "value_pac": "201300.00"}, {"href": "/organization/national-republican-senatorial-cmte/6bff9730496f42f0aad45a75b2033c75", "value_employee": "42724.00", "value": "213724.00", "key": "National Republican Senatorial Cmt...", "value_pac": "171000.00"}, {"href": "/organization/democratic-senatorial-campaign-cmte/19f0a07f21434a10b434281348f6daa8", "value_employee": "17800.00", "value": "178500.00", "key": "Democratic Senatorial Campaign Cmt...", "value_pac": "160700.00"}, {"href": "", "value_employee": "1000.00", "value": "151000.00", "key": "One United Michigan", "value_pac": "150000.00"}, {"href": "/organization/dnc-services-corp/e497407d2e834cd48e126093ed0416e5", "value_employee": "52331.00", "value": "86821.00", "key": "DNC Services Corp", "value_pac": "34490.00"}, {"href": "", "value_employee": "0", "value": "75400.00", "key": "Yes On 64 Californians To Stop Sha...", "value_pac": "75400.00"}, {"href": "", "value_employee": "2500.00", "value": "66820.00", "key": "House Republican Campaign Cmte Of ...", "value_pac": "64320.00"}] );
            Brisket.local_piechart("piechart_local",  {"in-state": 596631.0, "out-of-state": 2390208.0});
            Brisket.party_piechart("piechart_party", {"Republicans": 6537528.49, "Other": 407102.86, "Democrats": 3688388.89});
        </script>
    </body>
</html>