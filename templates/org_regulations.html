{% load humanize %}
{% load influence_extras %}

<div class="overviewBar">
  <a class="toggle">Toggle</a>
  <h3 class="insideBar">Regulations</h3>
      <div class="insideBar amount">
          <a class="descriptor" title="More Information" href="#regulationsDescriptor">Information</a>
          <div class="clear"></div>      
          <div class="descriptorText" id='regulationsDescriptor'>
            <p>Methodology goes here.</p>
          </div>      
    </div>
</div>

<div class="chartModule">

<div class="fulltext-disclaimer">Disclaimer goes here: these are full text matches against public comments on proposed regulations.</div>


{% if section.regulations_text %}
  <h5>Mentions in Document Text</h5>

  <div class="regTableHead">
      <div class="toggle active"></div>
      <div class="regColSmall">Mentions</div>
      <div class="regColSmall">Agency</div>
      <div class="regColLarge">Docket</div>
      <div class="regColSmall">Date</div>
      <div class="clear"></div>
  </div>
  <div class='regTable' id="regulations_text">
    {% for row in section.regulations_text %}
    <div class="{% cycle 'even' 'odd' %} regTableRow">
        <div class="toggle"><a class="toggle">Toggle</a></div>
        <div class="regColSmall">{{ row.count }}</div>
        <div class="regColSmall">{{ row.agency }}</div>
        <div class="regColLarge">
            <a class="docketTitle" href="http://www.regulations.gov/#!docketDetail;dct=FR+PR+N+O+SR+PS;rpp=10;po=0;D={{ row.docket }}" title="{{ row.docket }}">{{ row.title }}</a>
        </div>
        <div class="regColSmall">{{ row.year }}</div>
        <div class="clear"></div>
        <div class="loading"></div>
        <div class="regDocList"></div>
    </div>
    {% endfor %}
  </div>
{% endif %}

{% if section.regulations_submitter %}
  <h5>Documents Submitted by the Organization</h5>
  
  <div class="regTableHead">
      <div class="toggle active"></div>
      <div class="regColSmall">Submissions</div>
      <div class="regColSmall">Agency</div>
      <div class="regColLarge">Docket</div>
      <div class="regColSmall">Date</div>
      <div class="clear"></div>
  </div>
  <div class='regTable' id="regulations_submitter">
    {% for row in section.regulations_submitter %}
    <div class="{% cycle 'even' 'odd' %} regTableRow">
        <div class="toggle"><a class="toggle">Toggle</a></div>
        <div class="regColSmall">{{ row.count }}</div>
        <div class="regColSmall">{{ row.agency }}</div>
        <div class="regColLarge">
            <a class="docketTitle" href="http://www.regulations.gov/#!docketDetail;dct=FR+PR+N+O+SR+PS;rpp=10;po=0;D={{ row.docket }}" title="{{ row.docket }}">{{ row.title }}</a>
        </div>
        <div class="regColSmall">{{ row.year }}</div>
        <div class="clear"></div>
        <div class="loading"></div>
        <div class="regDocList"></div>
    </div>
    {% endfor %}
  </div>

{% endif %}

  <div class="clear"></div>
  
  <div class="external">
    {% if section.regs_links %}
    For more information on regulations:
    {% for link in section.regs_links %}
    <a href="{{ link.url }}" class="external" target="_blank">{{ link.text }}</a>
    {% endfor %}
    {% endif %}
  </div>
  
  <div class="clear"></div>
</div><!-- end chartModule -->

<script type="text/html" id="regPopDownTemplate">
  <table>
  <thead>
    <tr>
      <th>Document</th>
      <% if (type == "text") { %>
      <th>View</th>
      <% } %>
      <th>Date</th>
    </tr>
  </thead>
  <tbody>
  <% for (var i = 0; i < documents.length; i++) { %>
    <tr class="<%=(i % 2 == 0 ? 'even' : 'odd')%>">
      <td class="regDoc"><a href="http://www.regulations.gov/#!documentDetail;D=<%=documents[i].document_id%>" title="<%=documents[i].document_id%>"><%=documents[i].title%></a></td>
      <% if (type == "text") { %>
      <td class="regDocDl"><a href="#" class="pdf">Download the Document</a><a class="doc">Download the Document</a></td>
      <% } %>
      <td class="regDocDate"><%=documents[i].nice_date%></td>
    </tr>
  <% } %>
  </tbody>
</table>
</script>

<script type="text/javascript">
  $(function() {
    var months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December']
    var template = _.template($('#regPopDownTemplate').html());
    
    $('.regTableRow a.toggle').click(function() {
      var $this = $(this);
      var $row = $this.parents('.regTableRow');
      var $popdown = $row.find('.regDocList');
      var $loading = $row.find('.loading');
      
      if ($popdown.is(':visible')) {
        $popdown.slideUp('fast');
        $this.removeClass('active');
      } else {
        if (!$popdown.find('table').length) {
          var type = $row.parents('.regTable').get(0).id.split('_')[1];
          var docket = $row.find('a.docketTitle').attr('title');
          var entity = document.location.pathname.split('/').pop();
          
          var url = '{{ AGGREGATES_API_BASE_URL }}aggregates/org/' + entity +
            '/regulations_' + type + '_by_docket/' + docket +
            '.json?apikey={{ API_KEY }}&cycle=-1&callback=?';
          
          $loading.slideDown('fast');
          $.getJSON(url, function(data) {
            var table = template({'documents': $.map(data, function(row) {
              date = row.date_posted.split('-');
              return $.extend(row, {'nice_date': months[parseInt(date[1], 10) - 1] + ' ' + parseInt(date[2], 10) + ', ' + date[0]});
            }), 'type': type});
            $popdown.append(table);
            
            $loading.slideUp('fast');
            $popdown.slideDown('fast');
          })
        } else {
          $popdown.slideDown('fast');
        }
        
        $this.addClass('active');
      }
    });
  });
</script>